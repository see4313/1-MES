import{r as b,c as _e,o as De,b as l,w as i,N as L,Q as T,U as c,T as C,ac as f,aj as J,x as M,ap as $,s as h,aq as K,a as z,ar as O,u as g,d as U,a0 as W,t as X,V as Z,an as xe,F as Ne,c0 as ee}from"./index-vUQOwfGq.js";import{_ as ae}from"./CommonModal-DAUXa4tk.js";import{a as y}from"./index-NIGUFBhG.js";import{_ as Ie}from"./card-header-btn3k-6zMLpEnU.js";import{_ as te}from"./card-header-btn2k-CzsbA5Hq.js";import{s as we,a as x}from"./index-DzeG4XAE.js";import{d as le}from"./dayjs.min-CQa8u9th.js";import{_ as Be}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./_commonjsHelpers-gnU0ypJ3.js";const Ce={style:{display:"flex","align-items":"center",gap:"16px","margin-top":"-16px"}},Ue={class:"detail"},Ye={style:{display:"flex","align-items":"center",gap:"16px","margin-top":"-16px"}},Se={__name:"bom",setup(Me){const j=t=>t?t instanceof Date?t:new Date(t):null,Y=t=>t?le(t).format("YYYY-MM-DD"):"",k=t=>t?le(t).format("YYYY-MM-DD"):null,R=t=>Array.isArray(t)?t:(t==null?void 0:t.items)??(t==null?void 0:t.rows)??[],S=encodeURIComponent,v=b({searchStart:!1,searchEnd:!1,createStart:!1,createEnd:!1}),_=b(null),N=b(!1),V=b(!1),E=b("search"),s=b({bomNumber:"",itemId:"",itemName:"",ver:"",startDate:null,endDate:null,useYn:""}),n=b({id:null,itemId:"",itemName:"",ver:"",startDate:null,endDate:null,useYn:"",remark:""}),d=b([]),w=b(!1),B=b(null),I=b({open:!1,message:"",color:"success"}),r=(t,e="success")=>{I.value={open:!0,message:t,color:e}},F=async()=>{var t,e;v.value.searchStart=v.value.searchEnd=!1,v.value.createStart=v.value.createEnd=!1,N.value=V.value=!1,await ee(),(e=(t=document.activeElement)==null?void 0:t.blur)==null||e.call(t)},ne=async()=>{await F(),N.value=!0},P=async(t="search",e=null)=>{await F(),E.value=t,_.value=e,V.value=!0},ue=async(t="")=>{var e,a;try{const{data:u}=await y.get("/api/bom",{params:{bom_number:t||s.value.bomNumber||void 0,item_name:t||s.value.itemName||void 0,item_id:s.value.itemId||void 0,ver:s.value.ver||void 0,use_yn:s.value.useYn||void 0,start_date_from:k(s.value.startDate)||void 0,end_date_to:k(s.value.endDate)||void 0}});return R(u)}catch(u){return console.error("BOM 목록 오류:",u),r(((a=(e=u==null?void 0:u.response)==null?void 0:e.data)==null?void 0:a.message)||"BOM 목록을 불러오는 중 오류가 발생했습니다.","error"),[]}},q=async t=>{const{data:e}=await y.get(`/api/bom/${S(t)}/details`);return R(e)},ie=async(t="")=>{try{const{data:e}=await y.get("/api/item",{params:{keyword:t||void 0}});return R(e)}catch(e){return console.warn("[fetchItemList] API 조정 필요",(e==null?void 0:e.message)||e),[]}},se=async t=>{if(!t)return"";try{const{data:e}=await y.get("/api/bom/maxVersion",{params:{itemId:t}});return String((e==null?void 0:e.ver)??"").trim()}catch(e){return console.warn("fetchNextVerByItem error:",(e==null?void 0:e.message)||e),""}},oe=async t=>{n.value.ver=await se(t)},de=async t=>{var a,u;if(!t)return N.value=!1;const e=t.bom_number??t.bomNumber??"";n.value={id:e,itemId:t.item_id??t.itemId??"",itemName:t.item_name??t.itemName??"",ver:t.ver??"",startDate:t.start_date?j(t.start_date):null,endDate:t.end_date?j(t.end_date):null,useYn:t.use_yn??t.useYn??"Y",remark:t.remk??t.remark??""},N.value=!1,w.value=!0;try{d.value=await q(e)}catch(o){r(((u=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:u.message)||"상세 조회 중 오류가 발생했습니다.","error")}finally{w.value=!1}},re=async t=>{const e=(t==null?void 0:t.item_id)??"",a=(t==null?void 0:t.item_name)??"",u=(t==null?void 0:t.spec)??"",o=(t==null?void 0:t.unit)??"";if(!e){V.value=!1;return}if(E.value==="create"){if(!(n.value.itemId!==e)){V.value=!1;return}if((!!n.value.id||d.value.length>0||!!n.value.ver||!!n.value.startDate||!!n.value.endDate||!!n.value.remark)&&!window.confirm("품목을 변경하면 현재 입력값과 상세내역이 모두 초기화됩니다. 계속할까요?")){V.value=!1;return}n.value.itemId=e,n.value.itemName=a,Ve({hard:!0}),await oe(e)}else if(E.value==="detail"){if(_.value){const p=e,m=o||"";if(d.value.some(D=>D!==_.value&&((D==null?void 0:D.item_id)??"")===p&&((D==null?void 0:D.unit)??"")===m)){r("같은 품목/단위가 이미 있습니다.","warning"),V.value=!1;return}_.value.item_id=e,_.value.item_name=a,_.value.spec=u,_.value.unit=o}}else s.value.itemId=e,s.value.itemName=a;V.value=!1},G=t=>!!(t.itemId&&t.itemName&&t.startDate),H=async()=>{n.value={id:null,itemId:"",itemName:"",ver:"",startDate:null,endDate:null,useYn:"",remark:""},d.value=[],B.value=null,await ee()},me=async()=>{var e,a;if(!G(n.value))return r("필수 항목을 확인하세요.","warning");const t=!!n.value.id;try{if(t){const m={itemId:n.value.itemId,use:n.value.useYn||"Y",ver:n.value.ver,startDate:k(n.value.startDate),endDate:k(n.value.endDate),remk:n.value.remark||null};await y.put(`/api/bom/${S(n.value.id)}`,m),r("BOM 헤더가 수정되었습니다.");return}if(!window.confirm("등록하시겠습니까?"))return;const o={item_id:n.value.itemId,use_yn:n.value.useYn||"Y",start_date:k(n.value.startDate),end_date:k(n.value.endDate),remk:n.value.remark||null},p=Array.isArray(d.value)?d.value.map(m=>({item_id:m.item_id,unit:m.unit,usage:Number(m.usage)||0,loss:Number(m.loss??0)||0})):[];await y.post("/api/bom",{header:o,details:p}),r("BOM 등록이 완료되었습니다."),Q(),d.value=[]}catch(u){r(((a=(e=u==null?void 0:u.response)==null?void 0:e.data)==null?void 0:a.message)||(t?"수정 중 오류가 발생했습니다.":"등록 중 오류가 발생했습니다."),"error")}},Q=()=>{n.value={id:null,itemId:"",itemName:"",ver:"",startDate:null,endDate:null,useYn:"",remark:""}},ve=async()=>{Q(),d.value=[],B.value=null,await F()},ce=()=>{s.value={bomNumber:"",itemId:"",itemName:"",ver:"",startDate:null,endDate:null,useYn:""},v.value.searchStart=v.value.searchEnd=!1,d.value=[]},fe=()=>{d.value.push({item_id:"",item_name:"",spec:"",unit:"",usage:"",loss:""})},pe=async t=>{var o,p;if(!t)return;const e=d.value.findIndex(m=>m===t||m.bom_detail_no&&m.bom_detail_no===t.bom_detail_no);if(e<0)return r("행을 찾을 수 없습니다.","warning");const a=d.value[e];if(!(a!=null&&a.bom_detail_no)||!n.value.id){d.value.splice(e,1);return}const u=String(a.bom_detail_no).trim();if(!u)return r("상세번호가 올바르지 않습니다.","warning");if(window.confirm(`행 ${u} 를 삭제할까요?`))try{const m=encodeURIComponent(n.value.id),A=encodeURIComponent(u);await y.delete(`/api/bom/${m}/details/${A}`),d.value.splice(e,1),r("삭제되었습니다.")}catch(m){r(((p=(o=m==null?void 0:m.response)==null?void 0:o.data)==null?void 0:p.message)||"삭제 중 오류가 발생했습니다.","error")}},be=(t=d.value)=>{const e=Array.isArray(t)?t:[];for(let a=0;a<e.length;a++){const u=e[a]??{};if(!u.item_id)return`${a+1}행: 품목번호를 선택하세요.`;if(!u.unit)return`${a+1}행: 단위를 선택하세요.`;if(u.usage==null||Number(u.usage)<0)return`${a+1}행: 투입량은 0 이상이어야 합니다.`}return""},ye=async()=>{var e,a;if(!d.value.length)return r("추가된 상세 행이 없습니다.","warning");const t=be(d.value);if(t)return r(t,"warning");try{if(n.value.id){const u={details:d.value.map(o=>({item_id:o.item_id,unit:o.unit,usage:Number(o.usage)||0,loss:Number(o.loss??0)||0}))};await y.post(`/api/bom/${S(n.value.id)}/details`,u),r("상세 저장이 완료되었습니다."),await ge()}else{if(!G(n.value))return r("BOM을 먼저 선택하세요.","warning");const u={item_id:n.value.itemId,use_yn:n.value.useYn||"Y",start_date:k(n.value.startDate),end_date:k(n.value.endDate),remk:n.value.remark||null},o=d.value.map(p=>({item_id:p.item_id,unit:p.unit,usage:Number(p.usage)||0,loss:Number(p.loss??0)||0}));await y.post("/api/bom",{header:u,details:o}),r("저장 완료 (신규 생성)"),await H()}}catch(u){const o=((a=(e=u==null?void 0:u.response)==null?void 0:e.data)==null?void 0:a.message)||(u==null?void 0:u.message)||"저장 중 오류가 발생했습니다.";r(o,"error")}};function Ve(t={hard:!1}){(t==null?void 0:t.hard)===!0&&(n.value.id=null),n.value.ver="",n.value.startDate=null,n.value.endDate=null,n.value.useYn="",n.value.remark="",d.value=[],B.value=null}const ge=async(t=n.value.id)=>{var e,a;if(t){w.value=!0;try{const u=await q(t);d.value=u}catch(u){r(((a=(e=u==null?void 0:u.response)==null?void 0:e.data)==null?void 0:a.message)||"상세 재조회 중 오류가 발생했습니다.","error")}finally{w.value=!1}}},ke=async()=>{var a,u;if(!n.value.id)return r("삭제할 BOM이 없습니다.","warning");const t=String(n.value.id).trim();if(window.confirm(`BOM ${t} 를 삭제하시겠습니까?`))try{await y.delete(`/api/bom/${S(t)}`),r("BOM이 삭제되었습니다."),await H()}catch(o){r(((u=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:u.message)||"삭제 중 오류가 발생했습니다.","error")}};return(t,e)=>(De(),_e(Ne,null,[l(C,null,{default:i(()=>[l(L,{elevation:"10",class:"pa-6"},{default:i(()=>[l(T,{class:"py-6 px-6"}),l(te,{title:"BOM관리","btn-text2":"조회","btn-color2":"primary","btn-variant2":"flat",onBtnClick2:ne,"btn-text1":"초기화","btn-color1":"secondary","btn-variant1":"flat",onBtnClick1:ce}),l(c,{cols:"12",md:"12"},{default:i(()=>[l(C,{dense:""},{default:i(()=>[l(c,{cols:"12",sm:"4"},{default:i(()=>[l(f,{variant:"outlined",label:"BOM번호",modelValue:s.value.bomNumber,"onUpdate:modelValue":e[0]||(e[0]=a=>s.value.bomNumber=a)},null,8,["modelValue"])]),_:1}),l(c,{cols:"12",sm:"4"},{default:i(()=>[l(f,{variant:"outlined",label:"품목번호",modelValue:s.value.itemId,"onUpdate:modelValue":e[1]||(e[1]=a=>s.value.itemId=a),"append-inner-icon":"mdi-magnify","onClick:appendInner":e[2]||(e[2]=J(a=>P("search"),["stop"]))},null,8,["modelValue"])]),_:1}),l(c,{cols:"12",sm:"4"},{default:i(()=>[l(f,{variant:"outlined",label:"품목명",modelValue:s.value.itemName,"onUpdate:modelValue":e[3]||(e[3]=a=>s.value.itemName=a)},null,8,["modelValue"])]),_:1}),l(c,{cols:"12",sm:"4"},{default:i(()=>[l(f,{variant:"outlined",label:"버전",modelValue:s.value.ver,"onUpdate:modelValue":e[4]||(e[4]=a=>s.value.ver=a)},null,8,["modelValue"])]),_:1}),l(c,{cols:"12",sm:"4"},{default:i(()=>[l(M,{modelValue:v.value.searchStart,"onUpdate:modelValue":e[7]||(e[7]=a=>v.value.searchStart=a),"close-on-content-click":!1,transition:"scale-transition","offset-y":"","min-width":"auto"},{activator:i(({props:a})=>[l(f,h(a,{label:"시작일","append-inner-icon":"mdi-calendar",variant:"outlined","model-value":Y(s.value.startDate)}),null,16,["model-value"])]),default:i(()=>[l($,{modelValue:s.value.startDate,"onUpdate:modelValue":[e[5]||(e[5]=a=>s.value.startDate=a),e[6]||(e[6]=a=>v.value.searchStart=!1)]},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),l(c,{cols:"12",sm:"4"},{default:i(()=>[l(M,{modelValue:v.value.searchEnd,"onUpdate:modelValue":e[10]||(e[10]=a=>v.value.searchEnd=a),"close-on-content-click":!1,transition:"scale-transition","offset-y":"","min-width":"auto"},{activator:i(({props:a})=>[l(f,h(a,{label:"종료일","append-inner-icon":"mdi-calendar",variant:"outlined","model-value":Y(s.value.endDate)}),null,16,["model-value"])]),default:i(()=>[l($,{modelValue:s.value.endDate,"onUpdate:modelValue":[e[8]||(e[8]=a=>s.value.endDate=a),e[9]||(e[9]=a=>v.value.searchEnd=!1)]},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),l(c,{cols:"12",sm:"4"},{default:i(()=>[l(K,{modelValue:s.value.useYn,"onUpdate:modelValue":e[11]||(e[11]=a=>s.value.useYn=a),label:"사용여부",variant:"outlined",style:{width:"100%","--v-input-gap":"4px"}},{default:i(()=>[z("div",Ce,[l(O,{label:"사용",value:"Y"}),l(O,{label:"미사용",value:"N"})])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),l(C,null,{default:i(()=>[l(L,{elevation:"10",class:"pa-6 mt-2"},{default:i(()=>[l(c,{cols:"12"},{default:i(()=>[z("div",Ue,[l(T,{class:"py-6 px-6"},{default:i(()=>[l(te,{title:"BOM 상세정보","btn-icon2":"mdi-plus-circle","btn-text2":"행추가","btn-variant2":"flat","btn-color2":"#424242",onBtnClick2:fe,"btn-text1":"등록","btn-color1":"warning","btn-variant1":"flat",onBtnClick1:ye})]),_:1}),l(g(we),{selection:B.value,"onUpdate:selection":e[12]||(e[12]=a=>B.value=a),value:d.value,loading:w.value,tableStyle:"min-width: 50rem",rowHover:"",paginator:!0,rows:5,rowsPerPageOptions:[5,10,20,50],paginatorTemplate:"RowsPerPageDropdown PrevPageLink PageLinks NextPageLink"},{default:i(()=>[l(g(x),{field:"item_id",sortable:"",header:"품목번호"},{body:i(a=>[l(W,{class:"cursor-pointer",onClick:u=>P("detail",a.data),style:{"margin-left":"8px"}},{default:i(()=>e[29]||(e[29]=[U(" mdi-magnify ")])),_:2},1032,["onClick"]),U(" "+X(a.data.item_id),1)]),_:1}),l(g(x),{field:"item_name",header:"품목명"}),l(g(x),{field:"spec",header:"규격"}),l(g(x),{field:"unit",header:"단위"}),l(g(x),{field:"usage",header:"투입량"},{body:i(a=>[l(f,{modelValue:a.data.usage,"onUpdate:modelValue":u=>a.data.usage=u,modelModifiers:{number:!0},type:"number",dense:"","hide-details":"",style:{width:"100px"},variant:"outlined",min:"0",class:"right-align-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),l(g(x),{field:"loss",header:"손실률"},{body:i(a=>[l(f,{modelValue:a.data.loss,"onUpdate:modelValue":u=>a.data.loss=u,modelModifiers:{number:!0},type:"number",dense:"","hide-details":"",style:{width:"100px"},variant:"outlined",min:"0",class:"right-align-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),l(g(x),{style:{width:"80px","text-align":"center"}},{body:i(a=>[l(Z,{icon:"",color:"error",onClick:u=>pe(a.data)},{default:i(()=>[l(W,{size:"20"},{default:i(()=>e[30]||(e[30]=[U("mdi-delete")])),_:1})]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["selection","value","loading"])])]),_:1})]),_:1})]),_:1}),l(C,null,{default:i(()=>[l(L,{elevation:"10",class:"pa-6 mt-2"},{default:i(()=>[l(T,{class:"py-6 px-6"},{default:i(()=>[l(Ie,{title:"BOM등록","btn-text3":"저장","btn-color3":"warning","btn-variant3":"flat",onBtnClick3:g(me),"btn-text2":"삭제","btn-variant2":"flat","btn-color2":"error","btn-disabled2":!n.value.id,onBtnClick2:ke,"btn-text1":"초기화","btn-color1":"secondary","btn-variant1":"flat",onBtnClick1:ve},null,8,["onBtnClick3","btn-disabled2"])]),_:1}),l(c,{cols:"12",md:"12"},{default:i(()=>[l(C,{dense:""},{default:i(()=>[l(c,{cols:"12",sm:"4"},{default:i(()=>[l(f,{variant:"outlined",label:"품목번호",modelValue:n.value.itemId,"onUpdate:modelValue":e[13]||(e[13]=a=>n.value.itemId=a),"append-inner-icon":"mdi-magnify","onClick:appendInner":e[14]||(e[14]=J(a=>P("create"),["stop"])),readonly:""},null,8,["modelValue"])]),_:1}),l(c,{cols:"12",sm:"4"},{default:i(()=>[l(f,{variant:"outlined",label:"품목명",modelValue:n.value.itemName,"onUpdate:modelValue":e[15]||(e[15]=a=>n.value.itemName=a),readonly:""},null,8,["modelValue"])]),_:1}),l(c,{cols:"12",sm:"4"},{default:i(()=>[l(f,{variant:"outlined",label:"버전",modelValue:n.value.ver,"onUpdate:modelValue":e[16]||(e[16]=a=>n.value.ver=a),readonly:""},null,8,["modelValue"])]),_:1}),l(c,{cols:"12",sm:"4"},{default:i(()=>[l(M,{modelValue:v.value.createStart,"onUpdate:modelValue":e[19]||(e[19]=a=>v.value.createStart=a),"close-on-content-click":!1,transition:"scale-transition","offset-y":"","min-width":"auto"},{activator:i(({props:a})=>[l(f,h(a,{label:"시작일","append-inner-icon":"mdi-calendar",variant:"outlined","model-value":Y(n.value.startDate)}),null,16,["model-value"])]),default:i(()=>[l($,{modelValue:n.value.startDate,"onUpdate:modelValue":[e[17]||(e[17]=a=>n.value.startDate=a),e[18]||(e[18]=a=>v.value.createStart=!1)]},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),l(c,{cols:"12",sm:"4"},{default:i(()=>[l(M,{modelValue:v.value.createEnd,"onUpdate:modelValue":e[22]||(e[22]=a=>v.value.createEnd=a),"close-on-content-click":!1,transition:"scale-transition","offset-y":"","min-width":"auto"},{activator:i(({props:a})=>[l(f,h(a,{label:"종료일","append-inner-icon":"mdi-calendar",variant:"outlined","model-value":Y(n.value.endDate)}),null,16,["model-value"])]),default:i(()=>[l($,{modelValue:n.value.endDate,"onUpdate:modelValue":[e[20]||(e[20]=a=>n.value.endDate=a),e[21]||(e[21]=a=>v.value.createEnd=!1)]},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),l(c,{cols:"12",sm:"4"},{default:i(()=>[l(K,{modelValue:n.value.useYn,"onUpdate:modelValue":e[23]||(e[23]=a=>n.value.useYn=a),label:"사용여부",variant:"outlined",style:{width:"100%","--v-input-gap":"4px"}},{default:i(()=>[z("div",Ye,[l(O,{label:"사용",value:"Y"}),l(O,{label:"미사용",value:"N"})])]),_:1},8,["modelValue"])]),_:1}),l(c,{cols:"12",sm:"4"},{default:i(()=>[l(f,{variant:"outlined",label:"비고",modelValue:n.value.remark,"onUpdate:modelValue":e[24]||(e[24]=a=>n.value.remark=a)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),l(xe,{modelValue:I.value.open,"onUpdate:modelValue":e[26]||(e[26]=a=>I.value.open=a),timeout:2e3,color:I.value.color,location:"top right",rounded:"pill"},{actions:i(()=>[l(Z,{variant:"text",onClick:e[25]||(e[25]=a=>I.value.open=!1)},{default:i(()=>e[31]||(e[31]=[U("닫기")])),_:1})]),default:i(()=>[U(X(I.value.message)+" ",1)]),_:1},8,["modelValue","color"]),l(ae,{visible:N.value,"onUpdate:visible":e[27]||(e[27]=a=>N.value=a),"max-width":"1100px",title:"BOM검색",idField:"bom_number",columns:[{key:"bom_number",label:"BOM번호"},{key:"ver",label:"버전"},{key:"item_id",label:"품목번호"},{key:"item_name",label:"품목명"},{key:"start_date",label:"시작일"},{key:"end_date",label:"종료일"},{key:"use_yn",label:"사용여부"},{key:"remk",label:"비고"}],fetchData:ue,pageSize:5,onSelect:de},null,8,["visible"]),l(ae,{visible:V.value,"onUpdate:visible":e[28]||(e[28]=a=>V.value=a),title:"품목검색",idField:"item_id",columns:[{key:"item_id",label:"품목번호"},{key:"item_name",label:"품목명"},{key:"spec",label:"규격"},{key:"unit",label:"단위"}],fetchData:ie,pageSize:5,onSelect:re},null,8,["visible"])],64))}},ze=Be(Se,[["__scopeId","data-v-f0302699"]]);export{ze as default};
