import{a as P}from"./index-NIGUFBhG.js";import{_ as ue}from"./CommonModal-eUFOkW9R.js";import{_ as oe}from"./card-header-btn-DywzlSP9.js";import{u as re}from"./useFormatDate-DuO0KNBS.js";import{_ as ie}from"./SnackBar-EkLInYn6.js";import{u as de}from"./useSnackBar-CsLaRa2S.js";import{_ as me}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as i,D as j,M as A,c as V,o as v,b as n,w as s,U as G,N as T,Q as E,K,as as ce,F as N,z as U,W as B,a as l,T as R,V as k,d as f,x as W,ap as H,u as b,ac as L,s as J,al as ve,v as fe,a0 as O,t as o,a6 as pe,af as ye,e as Ve,h as be}from"./index-BkcQ_3tW.js";const xe={class:"text-center"},ge={class:"text-center"},ke={class:"text-center"},_e={class:"text-center"},Ne={class:"text-center"},Ce={class:"unit-label"},Ie={class:"text-center"},we={class:"text-center mb-4"},De={__name:"instruction",setup(qe){const{snackBar:c}=de(),{formatDate:p,minDate:z}=re(),y=i("semi"),C=i(!1),u=i([]),I=i(!1),d=i(null),w=i(!1),m=i(null),x=i(""),g=i(!1),_=i([]),M=i([{key:"반제품",value:"semi"},{key:"완제품",value:"finish"}]);j(y,()=>{u.value=[],_.value=[],u.value=[]}),j(()=>u.value.map(a=>a.quantity),()=>{for(const a of u.value){const e=a.quantity;(e<0||e===""||Number.isNaN(e))&&(a.quantity=0)}});const F=a=>{if(!a&&a!==0)return"";const e=Number(a);return Number.isNaN(e)?"":e.toLocaleString()},X=a=>{if(!a)return 0;const e=Number(String(a).replace(/,/g,""));return Number.isNaN(e)?0:e},Y=(a,e)=>{const t=X(e);a.quantity=t<0?0:Math.floor(t)},Z=async()=>{try{const{data:a}=await P.get(`/api/prod/itemlist/${y.value}`),e=ee.value;return(a??[]).filter(t=>!e.has(t.itemId))}catch(a){return console.error(a),[]}},h=a=>{const e=u.value.findIndex(t=>t.itemId===a);e!==-1&&u.value.splice(e,1)},Q=A(()=>u.value.map(a=>a.itemId)),ee=A(()=>new Set(Q.value)),D=(a,e)=>{switch(e.toLowerCase()){case"kg":return a*1e3;case"g":return a;case"mg":return a/1e3;case"l":return a*1e3;case"ml":return a;case"ea":return a;default:return a}},te=async a=>{u.value.push({...a,quantity:0});try{const e={item_id:a.itemId},t=await P.get("/api/prod/bomItemList",{params:e});_.value.push(...t.data.map(r=>({...r})))}catch{c("조회 실패","error")}},le=()=>{if(u.value.length===0){c("생산 지시할 품목을 선택해주세요.","warning");return}if(u.value.some(a=>a.quantity<1)){c("지시 수량을 다시 한번 확인하여 주세요.","warning");return}if(!m.value){c("생산 시작 일자를 선택하여주세요.","warning");return}if(!d.value){c("목표 생산 일자를 선택하여주세요.","warning");return}g.value=!0},ae=async()=>{const a=_.value.map(t=>{const r=u.value.find(se=>String(se.itemId)===String(t.parent_item)),ne=r?Number(r.quantity):0,q=D(t.conv_qty,t.unit),S=D(t.usage,t.unit)*ne;let $;return t.item_id==="P250815-0010"?$=Math.ceil(S/q):$=Math.ceil(S/q*10)/10,{item_id:t.item_id,conv_qty:q,loss:D(t.loss,t.unit),usageBom:S,use_qty:$}}),e=u.value.map(t=>({item_id:String(t.itemId),goal_qty:Number(t.quantity)}));g.value=!1;try{const{data:t}=await P.post("api/prod/instructions",{itemType:y.value,goalDate:p(d.value,"-"),startDate:p(m.value,"-"),remark:x.value,details:e,bomDetails:a});t.warningStatus==0?(u.value=[],_.value=[],m.value=null,d.value=null,x.value=null,c("성공적으로 생산 지시하였습니다.","success")):c("생산 지시 중 문제가 발생하였습니다.","error")}catch(t){console.error(t),c("생산 지시 중 문제가 발생하였습니다.","error")}};return(a,e)=>(v(),V(N,null,[n(R,null,{default:s(()=>[n(G,{cols:"9"},{default:s(()=>[n(T,{elevation:"10"},{default:s(()=>[n(E,{class:"py-6 px-6"},{default:s(()=>[n(K,{fluid:""},{default:s(()=>[n(oe,{title:"생산 지시","btn-icon":"mdi-plus-circle","btn-text":"생산 계획 불러오기","btn-variant":"outlined","btn-color":"primary",onBtnClick:()=>{}}),n(ce,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=t=>y.value=t),mandatory:"","selected-class":"active"},{default:s(()=>[(v(!0),V(N,null,U(M.value,t=>(v(),Ve(be,{key:t.value,value:t.value,label:"",pill:"",variant:"outlined",size:"small"},{default:s(()=>[f(o(t.key),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),n(B,{class:"fixed-table mt-4"},{default:s(()=>[e[15]||(e[15]=l("thead",null,[l("tr",null,[l("th",{class:"text-center"},"품목 번호"),l("th",{class:"text-center"},"품목 유형"),l("th",{class:"text-center"},"품목명"),l("th",{class:"text-center"},"규격"),l("th",{class:"text-center"},"지시 수량"),l("th",{class:"text-center"},"삭제")])],-1)),l("tbody",null,[(v(!0),V(N,null,U(u.value,t=>(v(),V("tr",{key:t.itemId},[l("td",xe,o(t.itemId),1),l("td",ge,o(t.itemType),1),l("td",ke,o(t.itemName),1),l("td",_e,o(t.spec),1),l("td",Ne,[n(L,{"model-value":F(t.quantity),"onUpdate:modelValue":r=>Y(t,r),type:"text",inputmode:"numeric",variant:"outlined","hide-details":"",density:"compact",class:"qty-input"},{"append-inner":s(()=>[l("span",Ce,o(t.unit||""),1)]),_:2},1032,["model-value","onUpdate:modelValue"])]),l("td",Ie,[n(k,{color:"error",size:"small",onClick:r=>h(t.itemId)},{default:s(()=>[n(O,null,{default:s(()=>e[14]||(e[14]=[f("mdi-delete")])),_:1})]),_:2},1032,["onClick"])])]))),128))])]),_:1}),n(R,{justify:"center",class:"my-4"},{default:s(()=>[n(k,{"append-icon":"mdi-plus-circle",variant:"outlined",color:"primary",onClick:e[1]||(e[1]=t=>C.value=!0)},{default:s(()=>e[16]||(e[16]=[f(" 품목 추가 ")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),n(G,{cols:"3"},{default:s(()=>[n(T,{elevation:"10"},{default:s(()=>[n(E,{class:"py-6 px-6"},{default:s(()=>[n(K,{fluid:""},{default:s(()=>[n(W,{modelValue:w.value,"onUpdate:modelValue":e[5]||(e[5]=t=>w.value=t),"close-on-content-click":!1,transition:"scale-transition"},{activator:s(({props:t})=>[n(L,J(t,{"model-value":b(p)(m.value,"-"),label:"생산 시작 일자","append-inner-icon":"mdi-calendar",readonly:"",variant:"outlined",density:"compact",clearable:"","onClick:clear":e[2]||(e[2]=r=>m.value=null)}),null,16,["model-value"])]),default:s(()=>[n(H,{modelValue:m.value,"onUpdate:modelValue":[e[3]||(e[3]=t=>m.value=t),e[4]||(e[4]=t=>w.value=!1)],min:b(z)(),max:d.value},null,8,["modelValue","min","max"])]),_:1},8,["modelValue"]),n(W,{modelValue:I.value,"onUpdate:modelValue":e[9]||(e[9]=t=>I.value=t),"close-on-content-click":!1,transition:"scale-transition"},{activator:s(({props:t})=>[n(L,J(t,{"model-value":b(p)(d.value,"-"),label:"목표 생산 일자","append-inner-icon":"mdi-calendar",readonly:"",variant:"outlined",density:"compact",clearable:"","onClick:clear":e[6]||(e[6]=r=>d.value=null)}),null,16,["model-value"])]),default:s(()=>[n(H,{modelValue:d.value,"onUpdate:modelValue":[e[7]||(e[7]=t=>d.value=t),e[8]||(e[8]=t=>I.value=!1)],min:m.value||b(z)()},null,8,["modelValue","min"])]),_:1},8,["modelValue"]),n(ve,{modelValue:x.value,"onUpdate:modelValue":e[10]||(e[10]=t=>x.value=t),label:"비고",variant:"outlined",density:"compact","auto-grow":"",rows:"3",clearable:""},null,8,["modelValue"]),n(k,{color:"primary",block:"",onClick:le},{default:s(()=>e[17]||(e[17]=[f("생산 지시")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),n(ye,{modelValue:g.value,"onUpdate:modelValue":e[12]||(e[12]=t=>g.value=t),"max-width":"600"},{default:s(()=>[n(T,{class:"pa-4 rounded-xl"},{default:s(()=>[l("div",we,[n(fe,{size:"48",color:"grey-lighten-4"},{default:s(()=>[n(O,{size:"28",color:"primary"},{default:s(()=>e[18]||(e[18]=[f("mdi-alert-circle-outline")])),_:1})]),_:1}),e[19]||(e[19]=l("h3",{class:"text-h6 font-weight-bold mt-2"},"등록하시겠습니까?",-1))]),n(B,{density:"comfortable",class:"mb-4"},{default:s(()=>{var t;return[l("tbody",null,[l("tr",null,[e[20]||(e[20]=l("td",null,"생산 유형",-1)),l("td",null,o((t=M.value.find(r=>r.value===y.value))==null?void 0:t.key),1)]),l("tr",null,[e[21]||(e[21]=l("td",null,"생산 시작 일자",-1)),l("td",null,o(b(p)(m.value,"-")),1)]),l("tr",null,[e[22]||(e[22]=l("td",null,"목표 생산 일자",-1)),l("td",null,o(b(p)(d.value,"-")),1)]),l("tr",null,[e[23]||(e[23]=l("td",null,"비고",-1)),l("td",null,o(x.value||"-"),1)])])]}),_:1}),n(B,{density:"compact",class:"mb-4"},{default:s(()=>[e[24]||(e[24]=l("thead",null,[l("tr",null,[l("th",null,"품목 번호"),l("th",null,"품목명"),l("th",null,"지시 수량")])],-1)),l("tbody",null,[(v(!0),V(N,null,U(u.value,t=>(v(),V("tr",{key:t.itemId},[l("td",null,o(t.itemId),1),l("td",null,o(t.itemName),1),l("td",null,o(F(t.quantity))+" "+o(t.unit),1)]))),128))])]),_:1}),n(pe,{class:"justify-end"},{default:s(()=>[n(k,{variant:"tonal",color:"grey-darken-1",onClick:e[11]||(e[11]=t=>g.value=!1)},{default:s(()=>e[25]||(e[25]=[f("취소")])),_:1}),n(k,{color:"primary",onClick:ae},{default:s(()=>e[26]||(e[26]=[f("확인")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(ue,{visible:C.value,title:"품목 검색",idField:"itemId",columns:[{key:"itemId",label:"품목 번호"},{key:"itemType",label:"품목 유형"},{key:"itemName",label:"품목명"}],fetchData:Z,"exclude-ids":Q.value,"page-size":5,onSelect:te,onClose:e[13]||(e[13]=t=>C.value=!1)},null,8,["visible","exclude-ids"]),n(ie)],64))}},Me=me(De,[["__scopeId","data-v-85e0638e"]]);export{Me as default};
